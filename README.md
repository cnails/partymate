# Partymate Telegram Bot

## Описание
Телеграм-бот для площадки partymate: роли (клиент, исполнительница, админ), поиск, заявки, биллинг, отзывы и модерация.

## Возможности
- Онбординг ролей.
- Поиск и фильтрация анкет.
- Заявки (статусы, подтверждения оплаты).
- Биллинг (планы/бусты).
- Отзывы и рейтинг.
- Модерация профилей и KYC.

Некоторые компоненты, такие как Redis и S3, являются опциональными, но поддерживаются.

## Развертывание
1. Скопируйте .env.example → .env, заполните переменные.
2. Поднимите Postgres и Redis: `docker compose up -d`.
3. Примените миграции: `npx prisma migrate dev --name init`.
4. Запустите: `npm run dev` (или `npm run build && npm start`).

## Переменные окружения
Описание переменных из [`.env.example`](.env.example). Значения по умолчанию и логика описаны в [src/config.ts](src/config.ts).

| Переменная | Обязательная | Пример | Назначение |
| --- | --- | --- | --- |
| `BOT_TOKEN` | да | `123456:abcdef...` | Токен Telegram-бота |
| `DATABASE_URL` | да | `postgresql://postgres:postgres@localhost:5432/gd_bot?schema=public` | Строка подключения к базе PostgreSQL |
| `WEBHOOK_DOMAIN` | нет | `https://example.com` | Домен для webhook; если не указан — включится polling |
| `WEBHOOK_PATH` | нет | `/tg/webhook` | Путь webhook (по умолчанию `/tg/webhook`) |
| `AUTO_APPROVE_PERFORMERS` | нет | `true` | Автоапрув анкет исполнительниц в dev (по умолчанию `false`) |
| `ADMIN_IDS` | нет | `123456789,987654321` | Telegram ID администраторов через запятую |
| `REDIS_URL` | нет | `redis://localhost:6379` | URL Redis (кеш/очереди) |
| `S3_ENDPOINT` | нет | `https://s3.example.com` | Endpoint S3-совместимого хранилища |
| `S3_ACCESS_KEY_ID` | нет | `AKIA...` | Ключ доступа S3 |
| `S3_SECRET_ACCESS_KEY` | нет | `secret` | Секретный ключ S3 |
| `S3_BUCKET` | нет | `partymate` | Имя S3 bucket |
| `S3_REGION` | нет | `us-east-1` | Регион S3 |
| `AUTO_APPROVE_BILLING` | нет | `true` | Автоподтверждение оплат (по умолчанию `false`) |
| `BOOST_7D_RUB` | нет | `500` | Цена 7‑дневного буста (по умолчанию `500`) |
| `PLAN_STD_30D_RUB` | нет | `900` | Цена стандартного плана на 30 дней (по умолчанию `900`) |
| `PLAN_PRO_30D_RUB` | нет | `1500` | Цена PRO-плана на 30 дней (по умолчанию `1500`) |
| `BILLING_INSTRUCTIONS` | нет | `Перевод на карту: ...` | Инструкции по оплате (по умолчанию текст из `config.ts`) |
| `TRIAL_DAYS` | нет | `60` | Пробный период для исполнительниц в днях (по умолчанию `60`) |

## Команды бота
- `/start` — выбор роли и вход в онбординг.
- `/help` — справка.
- `/listing` — (исполнительницы) управление анкетой.
- `/search` — (клиенты) подбор (пока заглушка).
- `/requests` — заявки (заглушка).
- `/report` — жалоба.

## Дальнейшие шаги
- Реализовать поиск/каталог (фильтры, сортировка, "онлайн сейчас").
- Добавить статусы заявок и приватный чат-связку.
- Встроить P2P-мету (пруф оплаты) и отзывы.
- Включить KYC-очередь и админ-бот/панель.
- Бусты и тарифы для исполнительниц.

### Новое в этом коммите
- /search <услуга>: поиск анкет (ACTIVE) по услуге, карточки с кнопкой «Оставить заявку».
- Мастер заявки: выбор услуги из профиля, длительность, пожелания по времени, создание Request.
- Флоу заявок: Принять/Отклонить → клиент «Оплатил» (загрузка пруфа) → «Получено» → PAID → DONE.
- Prisma: PaymentMeta.instructions, .env: AUTO_APPROVE_PERFORMERS=true для dev.

### Как быстро протестировать (polling)
1. Создайте `.env` со своим BOT_TOKEN и без WEBHOOK_DOMAIN (polling активируется сам).
2. `docker compose up -d` → `npx prisma migrate dev` → `npm run dev`.
3. В Telegram:
   - Зайдите как исполнительница → /start → роль → заполните анкету (в dev она сразу ACTIVE).
   - Вторым аккаунтом как клиент: `/search CS2` или `/search "Просто общение"` → откройте анкету → «Оставить заявку» → пройдите мастер.
   - От лица исполнительницы примите заявку; реквизиты отправятся автоматически при условии заполнения.
   - От клиента — «Оплатил» и загрузите скрин (photo/document).
   - От исполнительницы — «Получено». Готово.
