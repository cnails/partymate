# Partymate Telegram Bot

## Описание
Телеграм-бот для площадки partymate: роли (клиент, исполнительница, админ), поиск, заявки, биллинг, отзывы и модерация.

## Возможности
- Онбординг ролей.
- Поиск и фильтрация анкет.
- Заявки (статусы, подтверждения оплаты).
- Биллинг (планы/бусты).
- Отзывы и рейтинг.
- Модерация профилей и KYC.

Некоторые компоненты, такие как Redis и S3, являются опциональными, но поддерживаются.

## Развертывание
1. Скопируйте .env.example → .env, заполните переменные.
2. Поднимите Postgres и Redis: `docker compose up -d`.
3. Примените миграции: `npx prisma migrate dev --name init`.
4. Запустите: `npm run dev` (или `npm run build && npm start`).

## Переменные окружения
Описание переменных из [`.env.example`](.env.example). Значения по умолчанию и логика описаны в [src/config.ts](src/config.ts).

| Переменная | Обязательная | Пример | Назначение |
| --- | --- | --- | --- |
| `BOT_TOKEN` | да | `123456:abcdef...` | Токен Telegram-бота |
| `DATABASE_URL` | да | `postgresql://postgres:postgres@localhost:5432/gd_bot?schema=public` | Строка подключения к базе PostgreSQL |
| `WEBHOOK_DOMAIN` | нет | `https://example.com` | Домен для webhook; если не указан — включится polling |
| `WEBHOOK_PATH` | нет | `/tg/webhook` | Путь webhook (по умолчанию `/tg/webhook`) |
| `AUTO_APPROVE_PERFORMERS` | нет | `true` | Автоапрув анкет исполнительниц в dev (по умолчанию `false`) |
| `ADMIN_IDS` | нет | `123456789,987654321` | Telegram ID администраторов через запятую |
| `REDIS_URL` | нет | `redis://localhost:6379` | URL Redis (кеш/очереди) |
| `S3_ENDPOINT` | нет | `https://s3.example.com` | Endpoint S3-совместимого хранилища |
| `S3_ACCESS_KEY_ID` | нет | `AKIA...` | Ключ доступа S3 |
| `S3_SECRET_ACCESS_KEY` | нет | `secret` | Секретный ключ S3 |
| `S3_BUCKET` | нет | `partymate` | Имя S3 bucket |
| `S3_REGION` | нет | `us-east-1` | Регион S3 |
| `AUTO_APPROVE_BILLING` | нет | `true` | Автоподтверждение оплат (по умолчанию `false`) |
| `BOOST_7D_RUB` | нет | `500` | Цена 7‑дневного буста (по умолчанию `500`) |
| `BOOST_14D_RUB` | нет | `900` | Цена 14‑дневного буста (по умолчанию `900`) |
| `PLAN_STD_30D_RUB` | нет | `900` | Цена стандартного плана на 30 дней (по умолчанию `900`) |
| `PLAN_STD_90D_RUB` | нет | `2400` | Цена стандартного плана на 90 дней (по умолчанию `2400`) |
| `PLAN_PRO_30D_RUB` | нет | `1500` | Цена PRO-плана на 30 дней (по умолчанию `1500`) |
| `PLAN_PRO_90D_RUB` | нет | `4000` | Цена PRO-плана на 90 дней (по умолчанию `4000`) |
| `BILLING_INSTRUCTIONS` | нет | `Перевод на карту: ...` | Инструкции по оплате (по умолчанию текст из `config.ts`) |
| `TRIAL_DAYS` | нет | `60` | Пробный период для исполнительниц в днях (по умолчанию `60`) |

## Команды

### Общие
- `/start` — выбор роли и начало онбординга. Пример: `/start`.
- `/help` — справка по боту. Пример: `/help`.
- `/cancel` — отмена текущего действия. Пример: `/cancel`.

### Клиент
- `/search` — поиск анкет по услуге. Пример: `/search CS2`.
- `/requests` — просмотр созданных заявок. Пример: `/requests`.

### Исполнительница
- `/listing` — управление анкетой. Пример: `/listing`.
- `/requests` — заявки от клиентов. Пример: `/requests`.
- `/payinfo` — платёжные реквизиты. Пример: `/payinfo`.
- `/billing` — планы и бусты. Пример: `/billing`.

### Админ
- `/admin_billing` — управление оплатами. Пример: `/admin_billing`.
- другие `/admin_*` — команды администрирования по необходимости.

### Как быстро протестировать (polling)
1. Создайте `.env` со своим BOT_TOKEN и без WEBHOOK_DOMAIN (polling активируется сам).
2. `docker compose up -d` → `npx prisma migrate dev` → `npm run dev`.
3. В Telegram:
   - Зайдите как исполнительница → /start → роль → заполните анкету (в dev она сразу ACTIVE).
   - Вторым аккаунтом как клиент: `/search CS2` или `/search "Просто общение"` → откройте анкету → «Оставить заявку» → пройдите мастер.
   - От лица исполнительницы примите заявку; реквизиты отправятся автоматически при условии заполнения.
  - От клиента — «Оплатил» и загрузите скрин (photo/document).
  - От исполнительницы — «Получено». Готово.

## Тестирование и QA

- Инструкции по запуску тестов: [docs/TESTING.md](docs/TESTING.md).
- Диаграмма состояний заказов: [docs/BILLING_STATE.md](docs/BILLING_STATE.md).
- QA чек-лист: [docs/QA_CHECKLIST.md](docs/QA_CHECKLIST.md).

## FAQ

### Зачем нужен буст?
Буст поднимает анкету в поисковой выдаче на 7 дней и помогает быстрее получать заявки.

### Чем отличаются тарифы STANDARD и PRO?
STANDARD открывает дополнительные функции и даёт базовый приоритет в поиске. PRO включает всё из STANDARD и добавляет максимальный приоритет и новые функции в первую очередь.
