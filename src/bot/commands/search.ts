import { Telegraf, Scenes, Markup } from 'telegraf';
import { prisma } from '../../services/prisma.js';
import { gamesList } from '../keyboards.js';

const planWeight: Record<string, number> = { BASIC: 0, STANDARD: 1, PRO: 2 };

export const registerSearch = (bot: Telegraf, stage: Scenes.Stage) => {
  bot.command('search', async (ctx) => {
    const text = ctx.message && 'text' in ctx.message ? ctx.message.text : '/search';
    const arg = text.split(' ').slice(1).join(' ').trim();

    if (!arg) {
      await ctx.reply(`–£–∫–∞–∂–∏—Ç–µ –∏–≥—Ä—É –ø–æ—Å–ª–µ –∫–æ–º–∞–Ω–¥—ã, –Ω–∞–ø—Ä–∏–º–µ—Ä: 
/search CS2

–î–æ—Å—Ç—É–ø–Ω–æ: ${gamesList.join(', ')}`);
      return;
    }

    const game = gamesList.find((g) => g.toLowerCase() === arg.toLowerCase());
    if (!game) {
      await ctx.reply(`–ò–≥—Ä–∞ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞. –î–æ—Å—Ç—É–ø–Ω–æ: ${gamesList.join(', ')}`);
      return;
    }

    const raw = await prisma.performerProfile.findMany({
      where: { status: 'ACTIVE', games: { has: game } },
      take: 30,
      orderBy: [{ boostUntil: 'desc' }, { rating: 'desc' }, { createdAt: 'desc' }],
      include: { user: true },
    });

    // –î–æ–º–µ—à–∞–µ–º –≤–µ—Å –ø–ª–∞–Ω–∞ –≤—Ä—É—á–Ω—É—é –∏ —Å–æ–∫—Ä–∞—Ç–∏–º –¥–æ 10
    const profiles = raw
      .map((p) => ({
        p,
        boostKey: p.boostUntil ? new Date(p.boostUntil).getTime() : 0,
        planKey: planWeight[(p.plan as any) || 'BASIC'] || 0,
        rating: p.rating || 0,
      }))
      .sort((a, b) => {
        if (b.boostKey !== a.boostKey) return b.boostKey - a.boostKey;
        if (b.planKey !== a.planKey) return b.planKey - a.planKey;
        if (b.rating !== a.rating) return b.rating - a.rating;
        return (b.p.createdAt as any) - (a.p.createdAt as any);
      })
      .slice(0, 10)
      .map((x) => x.p);

    if (!profiles.length) {
      await ctx.reply('–ü–æ–∫–∞ –Ω–µ—Ç –∞–Ω–∫–µ—Ç –ø–æ —ç—Ç–æ–π –∏–≥—Ä–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –¥—Ä—É–≥—É—é –∏–≥—Ä—É.');
      return;
    }

    const rows = profiles.map((p) => {
      const labels: string[] = [];
      if (p.isBoosted && p.boostUntil && new Date(p.boostUntil).getTime() > Date.now()) labels.push('üöÄ');
      if (p.plan && p.plan !== 'BASIC') labels.push(p.plan === 'PRO' ? 'üèÜ' : '‚≠êÔ∏è');
      const title = `${labels.join(' ')} ${p.user.username ? '@' + p.user.username : 'ID ' + p.userId} ‚Äî ${p.pricePerHour}‚ÇΩ/—á`.trim();
      return [Markup.button.callback(title, `view_pf:${p.id}`)];
    });

    await ctx.reply(`–ù–∞–π–¥–µ–Ω–æ ${profiles.length} –∞–Ω–∫–µ—Ç –ø–æ –∏–≥—Ä–µ ${game}:`, Markup.inlineKeyboard(rows));
  });

  bot.on('callback_query', async (ctx, next) => {
    const data = (ctx.callbackQuery as any)?.data as string | undefined;
    if (!data) return next();

    if (data.startsWith('view_pf:')) {
      const id = Number(data.split(':')[1]);
      const p = await prisma.performerProfile.findUnique({ where: { id }, include: { user: true } });
      if (!p || p.status !== 'ACTIVE') { await ctx.answerCbQuery?.('–ê–Ω–∫–µ—Ç–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞'); return; }

      const labels: string[] = [];
      if (p.isBoosted && p.boostUntil && new Date(p.boostUntil).getTime() > Date.now()) labels.push('üöÄ Boost');
      if (p.plan && p.plan !== 'BASIC') labels.push(p.plan === 'PRO' ? 'üèÜ PRO' : '‚≠êÔ∏è STANDARD');

      const header = [
        `${labels.length ? labels.join(' ¬∑ ') + ' ¬∑ ' : ''}üéÆ –ê–Ω–∫–µ—Ç–∞ #${p.id}`,
        `–ò–≥—Ä—ã: ${p.games.join(', ')}`,
        `–¶–µ–Ω–∞: ${p.pricePerHour}‚ÇΩ/—á`,
        p.about ? `–û —Å–µ–±–µ: ${p.about}` : undefined,
        p.rating ? `–†–µ–π—Ç–∏–Ω–≥: ${p.rating.toFixed(1)}` : undefined,
      ].filter(Boolean).join('\n');

      const kb: any[] = [];
      kb.push([Markup.button.callback('–û—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É', `req_pf:${p.userId}`)]);
      if (p.voiceSampleUrl?.startsWith('tg:')) kb.push([Markup.button.callback('üé§ –ì–æ–ª–æ—Å', `play_voice:${p.userId}`)]);
      if ((p.photos?.length || 0) > 0) kb.push([Markup.button.callback('üì∑ –ì–∞–ª–µ—Ä–µ—è', `view_gallery:${p.userId}`)]);

      await ctx.editMessageText(header, Markup.inlineKeyboard(kb));
      return;
    }

    if (data.startsWith('req_pf:')) {
      const performerUserId = Number(data.split(':')[1]);
      await ctx.answerCbQuery?.();
      await ctx.scene.enter('requestWizard', { performerUserId });
      return;
    }

    // –ì–æ–ª–æ—Å–æ–≤–∞—è –ø—Ä–æ–±–∞
    if (data.startsWith('play_voice:')) {
      const userId = Number(data.split(':')[1]);
      const u = await prisma.user.findUnique({ where: { id: userId }, include: { performerProfile: true } });
      const fileId = u?.performerProfile?.voiceSampleUrl?.startsWith('tg:') ? u.performerProfile.voiceSampleUrl.slice(3) : null;
      await ctx.answerCbQuery?.();
      if (!fileId) { await ctx.reply('–ì–æ–ª–æ—Å–æ–≤–∞—è –ø—Ä–æ–±–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.'); return; }
      try { await ctx.replyWithVoice(fileId); } catch { await ctx.reply('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≥–æ–ª–æ—Å–æ–≤—É—é –ø—Ä–æ–±—É.'); }
      return;
    }

    // –ì–∞–ª–µ—Ä–µ—è
    if (data.startsWith('view_gallery:')) {
      const userId = Number(data.split(':')[1]);
      const u = await prisma.user.findUnique({ where: { id: userId }, include: { performerProfile: true } });
      const photos = u?.performerProfile?.photos || [];
      await ctx.answerCbQuery?.();
      if (!photos.length) { await ctx.reply('–ì–∞–ª–µ—Ä–µ—è –ø—É—Å—Ç–∞.'); return; }
      const media = photos.slice(0, 10).map((s, i) => ({
        type: 'photo',
        media: s.startsWith('tg:') ? s.slice(3) : s,
        caption: i === 0 ? `–ì–∞–ª–µ—Ä–µ—è (${photos.length} —Ñ–æ—Ç–æ)` : undefined,
      }));
      try {
        // @ts-ignore
        await ctx.replyWithMediaGroup(media);
      } catch {
        for (const [i, s] of photos.entries()) {
          try {
            if (i === 0) await ctx.replyWithPhoto(s.startsWith('tg:') ? s.slice(3) : s, { caption: `–ì–∞–ª–µ—Ä–µ—è (${photos.length} —Ñ–æ—Ç–æ)` });
            else await ctx.replyWithPhoto(s.startsWith('tg:') ? s.slice(3) : s);
          } catch {}
        }
      }
      return;
    }

    return next();
  });
};
